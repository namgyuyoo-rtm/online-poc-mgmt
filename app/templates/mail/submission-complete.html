{% extends "base.html" %}

{% block title %}RTM AI POC 접수 완료 메일{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 왼쪽: 폼 -->
        <div class="col-md-6">
            <div class="form-container">
                <h1 class="mb-4">RTM AI POC 제출 완료 메일 발송</h1>
                
                <!-- 프로젝트 정보 입력 -->
                <div class="mb-4">
                    <h4>프로젝트 정보 입력</h4>
                    <div class="mb-4">
                        <label for="pasteArea" class="form-label">프로젝트 정보 붙여넣기</label>
                        <textarea id="pasteArea" class="form-control" rows="10" placeholder="프로젝트 정보를 복사하여 붙여넣으세요"></textarea>
                        <button type="button" class="btn btn-primary mt-2" onclick="parsePastedData()">정보 확인</button>
                    </div>
                    
                    <!-- 검증 결과 표시 영역 -->
                    <div id="validationResult" class="mb-4">
                        <div class="alert alert-info" role="alert">
                            프로젝트 정보를 붙여넣고 '정보 확인' 버튼을 클릭해주세요.
                        </div>
                    </div>
                </div>

                {% if project %}
                <div class="mb-4">
                    <h5>프로젝트 정보</h5>
                    <div class="card">
                        <div class="card-body">
                            <p><strong>프로젝트 ID:</strong> {{ project.id }}</p>
                            <p><strong>상태:</strong> {{ project.status.value }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <form method="POST" id="emailForm">
                    {{ form.csrf_token }}
                    {{ form.project_id(type="hidden") }}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control") }}
                            {% if form.name.errors %}
                                <div class="text-danger">{{ form.name.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.company.label(class="form-label") }}
                            {{ form.company(class="form-control") }}
                            {% if form.company.errors %}
                                <div class="text-danger">{{ form.company.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control") }}
                            {% if form.email.errors %}
                                <div class="text-danger">{{ form.email.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control") }}
                            {% if form.phone.errors %}
                                <div class="text-danger">{{ form.phone.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.project_type.label(class="form-label") }}
                            {{ form.project_type(class="form-control") }}
                            {% if form.project_type.errors %}
                                <div class="text-danger">{{ form.project_type.errors[0] }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.project_url.label(class="form-label") }}
                            {{ form.project_url(class="form-control") }}
                            {% if form.project_url.errors %}
                                <div class="text-danger">{{ form.project_url.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.purpose.label(class="form-label") }}
                        {{ form.purpose(class="form-control", rows=3) }}
                        {% if form.purpose.errors %}
                            <div class="text-danger">{{ form.purpose.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="sendEmailBtn" onclick="sendEmail()" disabled>
                            이메일 발송
                        </button>
                        {% if project %}
                        <a href="{{ url_for('main.project_detail', project_id=project.id) }}" class="btn btn-secondary">
                            돌아가기
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- 오른쪽: 미리보기 -->
        <div class="col-md-6">
            <div class="preview-container">
                <h3 class="mb-3">이메일 미리보기</h3>
                <iframe id="previewFrame" class="preview-frame"></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .container-fluid {
        max-width: 1600px;
        margin: 0 auto;
    }
    .form-container, .preview-container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: calc(100vh - 40px);
        overflow-y: auto;
    }
    .preview-container {
        position: sticky;
        top: 20px;
    }
    .preview-frame {
        width: 100%;
        height: calc(100vh - 200px);
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    #pasteArea {
        width: 100%;
        height: 200px;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        resize: vertical;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
async function parsePastedData() {
    const pastedText = document.getElementById('pasteArea').value;
    console.log('=== 파싱 시작 ===');
    console.log('붙여넣은 텍스트:', pastedText);
    
    // 프로젝트 ID 찾기 (UUID 형식)
    const projectIdPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
    const projectIdMatch = pastedText.match(projectIdPattern);
    const projectId = projectIdMatch ? projectIdMatch[0] : null;
    
    console.log('=== 발견된 정보 ===');
    console.log('프로젝트 ID:', projectId);
    
    if (!projectId) {
        console.log('=== 검증 실패: 프로젝트 ID 누락 ===');
        const validationResult = document.getElementById('validationResult');
        validationResult.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> 프로젝트 ID를 찾을 수 없습니다.
            </div>
        `;
        document.getElementById('sendEmailBtn').disabled = true;
        return;
    }
    
    // 현재 페이지의 프로젝트 ID 확인
    const currentProjectId = '{{ project.id if project else "" }}';
    console.log('=== 프로젝트 ID 비교 ===');
    console.log('발견된 ID:', projectId);
    console.log('현재 페이지 ID:', currentProjectId);
    
    // 프로젝트 검증
    try {
        console.log('=== 프로젝트 검증 시작 ===');
        
        console.log('=== 프로젝트 ID 비교 ===');
        console.log('발견된 ID:', projectId);
        console.log('현재 페이지 ID:', '{{ project.id if project else "" }}');
        
        const response = await fetch(`/project/${projectId}/validate-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                // 상태 제약 조건 제거
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('=== 서버 응답 ===');
        console.log('응답 데이터:', result);
        
        if (result.success) {
            console.log('=== 검증 성공 ===');
            const validationResult = document.getElementById('validationResult');
            validationResult.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <i class="bi bi-check-circle-fill"></i> 프로젝트 정보가 확인되었습니다.
                </div>
            `;
            document.getElementById('sendEmailBtn').disabled = false;
            
            // 폼 필드 업데이트
            const form = document.getElementById('emailForm');
            if (form) {
                // 폼 필드 업데이트
                const fields = {
                    'name': result.project.name,
                    'company': result.project.company,
                    'email': result.project.email,
                    'phone': result.project.phone,
                    'project_type': result.project.project_type,
                    'project_id': result.project.id,
                    'project_url': result.project.project_url,
                    'purpose': result.project.purpose
                };

                // 각 필드 개별적으로 업데이트
                for (const [fieldId, value] of Object.entries(fields)) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value;
                        console.log(`${fieldId} 필드 업데이트 성공`);
                    } else {
                        console.error(`${fieldId} 필드를 찾을 수 없습니다.`);
                    }
                }
                
                // 미리보기 업데이트
                updatePreview();
            } else {
                console.error('폼을 찾을 수 없습니다.');
            }
        } else {
            console.log('=== 검증 실패 ===');
            console.log('에러 메시지:', result.message);
            const validationResult = document.getElementById('validationResult');
            validationResult.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> ${result.message}
                </div>
            `;
            document.getElementById('sendEmailBtn').disabled = true;
        }
    } catch (error) {
        console.log('=== 에러 발생 ===');
        console.log('에러:', error);
        const validationResult = document.getElementById('validationResult');
        validationResult.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> 프로젝트 검증 중 오류가 발생했습니다: ${error.message || '알 수 없는 오류'}
            </div>
        `;
        document.getElementById('sendEmailBtn').disabled = true;
    }
}

function updatePreview() {
    const form = document.getElementById('emailForm');
    if (!form) {
        console.error('폼을 찾을 수 없습니다.');
        return;
    }

    const formData = {
        name: form.querySelector('[name="name"]').value,
        company: form.querySelector('[name="company"]').value,
        email: form.querySelector('[name="email"]').value,
        phone: form.querySelector('[name="phone"]').value,
        project_type: form.querySelector('[name="project_type"]').value,
        project_id: form.querySelector('[name="project_id"]').value,
        purpose: form.querySelector('[name="purpose"]').value || '',
        project_url: form.querySelector('[name="project_url"]').value || ''
    };

    console.log('미리보기 데이터:', formData);

    fetch('/preview/submission-complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(html => {
        const previewFrame = document.getElementById('previewFrame');
        if (!previewFrame) {
            console.error('미리보기 프레임을 찾을 수 없습니다.');
            return;
        }

        const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        doc.open();
        doc.write(html);
        doc.close();

        // 미리보기 프레임 크기 조정
        previewFrame.style.height = 'auto';
        previewFrame.style.height = previewFrame.contentWindow.document.body.scrollHeight + 'px';
    })
    .catch(error => {
        console.error('미리보기 업데이트 중 오류:', error);
        const validationResult = document.getElementById('validationResult');
        validationResult.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> 미리보기 업데이트 중 오류가 발생했습니다.
            </div>
        `;
    });
}

function sendEmail() {
    const formData = {
        name: document.getElementById('name').value,
        company: document.getElementById('company').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        project_type: document.getElementById('project_type').value,
        project_id: document.getElementById('project_id').value,
        purpose: document.getElementById('purpose').value || '',
        project_url: document.getElementById('project_url').value || '',
        update_status: true // 이메일 전송 후 프로젝트 상태를 reception_complete로 업데이트
    };

    const projectId = document.getElementById('project_id').value;
    console.log('이메일 전송 시작, 프로젝트 ID:', projectId);

    fetch(`/project/${projectId}/send-email/submission-complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            // HTTP 오류 발생 시 응답을 JSON으로 파싱하여 오류 메시지 추출
            return response.json().then(errorData => {
                throw new Error(`서버 오류 (${response.status}): ${errorData.message || '알 수 없는 오류'}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('이메일이 성공적으로 전송되었습니다.');
            window.location.href = `/project/${projectId}`;
        } else {
            alert('이메일 전송 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('이메일 전송 중 오류:', error);
        alert('이메일 전송 중 오류가 발생했습니다: ' + error.message);
    });
}

// 폼 필드 변경 감지
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('emailForm');
    if (form) {
        form.addEventListener('input', function() {
            console.log('폼 필드 변경 감지');
            updatePreview();
        });
    }
});

// 초기 미리보기 업데이트
document.addEventListener('DOMContentLoaded', function() {
    console.log('초기 미리보기 업데이트');
    updatePreview();
});
</script>
{% endblock %} 