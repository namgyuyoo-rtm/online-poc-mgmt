{% extends "base.html" %}

{% block title %}프로젝트 상세 정보{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 프로젝트 기본 정보 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">프로젝트 기본 정보</h5>
                <span class="badge fs-6 {% if project.status.value == 'application_complete' %}bg-primary
                    {% elif project.status.value == 'reception_complete' %}bg-info
                    {% elif project.status.value == 'poc_in_progress' %}bg-warning text-dark
                    {% elif project.status.value == 'poc_complete' %}bg-success
                    {% elif project.status.value == 'cancelled' %}bg-danger
                    {% endif %}">
                    {% if project.status.value == 'application_complete' %}
                        신청 완료
                    {% elif project.status.value == 'reception_complete' %}
                        접수 완료
                    {% elif project.status.value == 'poc_in_progress' %}
                        POC 진행중
                    {% elif project.status.value == 'poc_complete' %}
                        POC 완료
                    {% elif project.status.value == 'cancelled' %}
                        취소됨
                    {% endif %}
                </span>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>프로젝트 ID:</strong> {{ project.id }}</p>
                    <p><strong>담당자:</strong> {{ project.name }}</p>
                    <p><strong>회사명:</strong> {{ project.company }}</p>
                    <p><strong>이메일:</strong> {{ project.email }}</p>
                    <p><strong>연락처:</strong> {{ project.phone }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>프로젝트 유형:</strong> {{ project.project_type }}</p>
                    <p><strong>생성일:</strong> {{ project.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p><strong>예상 완료일:</strong> {{ project.expected_report_date.strftime('%Y-%m-%d') if project.expected_report_date else '미정' }}</p>
                    {% if project.project_url %}
                    <p><strong>프로젝트 URL:</strong> <a href="{{ project.project_url }}">{{ project.project_url }}</a></p>
                    {% endif %}
                </div>
            </div>
            {% if project.purpose %}
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>과제 목적:</strong></p>
                    <p>{{ project.purpose }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 프로젝트 진행 상태 -->
    <div class="row">
        <!-- 신청 완료 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if project.status.value != 'application_complete' or project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length > 0 %}bg-light{% endif %}">
                <div class="card-header {% if project.status.value == 'application_complete' and project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length == 0 %}bg-primary text-white{% endif %}">
                    <h5 class="card-title mb-0">1. 신청 완료</h5>
                </div>
                <div class="card-body">
                    {% set initial_history = project.status_history|selectattr("new_status.value", "equalto", "application_complete")|first %}
                    {% if initial_history %}
                    <p class="small text-muted">처리일: {{ initial_history.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                    
                    {% if project.status.value == 'application_complete' and project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length == 0 %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="sendEmail('application-complete')">
                            신청 완료 메일 보내기
                        </button>
                        <button class="btn btn-success" onclick="updateStatus('RECEPTION_COMPLETE')">
                            메일 발송 완료 처리
                        </button>
                        <button class="btn btn-danger mt-3" onclick="showCancelModal()">
                            프로젝트 취소
                        </button>
                    </div>
                    {% else %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" disabled>{% if project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length > 0 %}처리 완료{% else %}처리 완료{% endif %}</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 접수 완료 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if project.status.value not in ['reception_complete', 'application_complete'] or project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length == 0 %}bg-light{% endif %}">
                <div class="card-header {% if project.status.value == 'reception_complete' or project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length > 0 %}bg-primary text-white{% endif %}">
                    <h5 class="card-title mb-0">2. 접수 완료</h5>
                </div>
                <div class="card-body">
                    {% set reception_history = project.status_history|selectattr("new_status.value", "equalto", "reception_complete")|first %}
                    {% if reception_history %}
                    <p class="small text-muted">처리일: {{ reception_history.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}

                    {% if project.email_history|selectattr('email_type.value', 'equalto', 'application-complete')|list|length > 0 and project.email_history|selectattr('email_type.value', 'equalto', 'submission-complete')|list|length == 0 %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="sendEmail('submission-complete')">
                            접수 완료 메일 보내기
                        </button>
                        <button class="btn btn-success" onclick="startAnalysis()">
                            분석 시작
                        </button>
                        <button class="btn btn-danger mt-3" onclick="showCancelModal()">
                            프로젝트 취소
                        </button>
                    </div>
                    {% elif project.email_history|selectattr('email_type.value', 'equalto', 'submission-complete')|list|length > 0 %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" disabled>처리 완료</button>
                    </div>
                    {% else %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" disabled>대기 중</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- POC 진행중 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if project.status.value not in ['poc_in_progress', 'reception_complete', 'application_complete'] %}bg-light{% endif %}">
                <div class="card-header {% if project.status.value == 'poc_in_progress' %}bg-primary text-white{% endif %}">
                    <h5 class="card-title mb-0">3. POC 진행</h5>
                </div>
                <div class="card-body">
                    {% set poc_history = project.status_history|selectattr("new_status.value", "equalto", "poc_in_progress")|first %}
                    {% if poc_history %}
                    <p class="small text-muted">시작일: {{ poc_history.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}

                    {% if project.status.value == 'poc_in_progress' %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="showExtendModal()">
                            기간 연장 안내하기
                        </button>
                        <button class="btn btn-success" onclick="showReportModal()">
                            리포트 업로드 및 완료
                        </button>
                        <button class="btn btn-danger mt-3" onclick="showCancelModal()">
                            프로젝트 취소
                        </button>
                    </div>
                    {% else %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" disabled>{% if project.status.value in ['application_complete', 'reception_complete'] %}대기 중{% else %}처리 완료{% endif %}</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- POC 완료 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 {% if project.status.value != 'poc_complete' %}bg-light{% endif %}">
                <div class="card-header {% if project.status.value == 'poc_complete' %}bg-success text-white{% endif %}">
                    <h5 class="card-title mb-0">4. POC 완료</h5>
                </div>
                <div class="card-body">
                    {% set complete_history = project.status_history|selectattr("new_status.value", "equalto", "poc_complete")|first %}
                    {% if complete_history %}
                    <p class="small text-muted">완료일: {{ complete_history.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% if project.report_file %}
                    <p><a href="{{ url_for('main.download_report', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                        리포트 다운로드
                    </a></p>
                    {% endif %}
                    {% endif %}

                    {% if project.status.value != 'poc_complete' %}
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" disabled>대기 중</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 취소됨 -->
        {% if project.status.value == 'cancelled' %}
        <div class="col-md-6 mb-4">
            <div class="card h-100 bg-danger text-white">
                <div class="card-header">
                    <h5 class="card-title mb-0">프로젝트 취소</h5>
                </div>
                <div class="card-body">
                    {% set cancel_history = project.status_history|selectattr("new_status.value", "equalto", "cancelled")|first %}
                    {% if cancel_history %}
                    <p>취소일: {{ cancel_history.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p>취소 사유: {{ project.cancel_reason }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 이메일 히스토리 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">이메일 발송 이력</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>발송 시각</th>
                            <th>유형</th>
                            <th>제목</th>
                            <th>수신자</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for email in project.email_history|sort(attribute='sent_at', reverse=true) %}
                        <tr>
                            <td>{{ email.sent_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if email.email_type.value == 'application-complete' %}
                                    신청 완료 메일
                                {% elif email.email_type.value == 'submission-complete' %}
                                    접수 완료 메일
                                {% elif email.email_type.value == 'cancellation' %}
                                    취소 안내 메일
                                {% elif email.email_type.value == 'delay' %}
                                    기간 연장 메일
                                {% elif email.email_type.value == 'report' %}
                                    POC 완료 메일
                                {% endif %}
                            </td>
                            <td>{{ email.subject }}</td>
                            <td>{{ email.recipient }}</td>
                            <td>
                                <span class="badge {% if email.status == 'success' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ '성공' if email.status == 'success' else '실패' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 상태 변경 이력 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">상태 변경 이력</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>변경 시각</th>
                            <th>이전 상태</th>
                            <th>새로운 상태</th>
                            <th>변경자</th>
                            <th>사유</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in project.status_history|sort(attribute='created_at', reverse=true) %}
                        <tr>
                            <td>{{ history.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if history.previous_status.value == 'application_complete' %}
                                    신청 완료
                                {% elif history.previous_status.value == 'reception_complete' %}
                                    접수 완료
                                {% elif history.previous_status.value == 'poc_in_progress' %}
                                    POC 진행중
                                {% elif history.previous_status.value == 'poc_complete' %}
                                    POC 완료
                                {% elif history.previous_status.value == 'cancelled' %}
                                    취소됨
                                {% endif %}
                            </td>
                            <td>
                                {% if history.new_status.value == 'application_complete' %}
                                    신청 완료
                                {% elif history.new_status.value == 'reception_complete' %}
                                    접수 완료
                                {% elif history.new_status.value == 'poc_in_progress' %}
                                    POC 진행중
                                {% elif history.new_status.value == 'poc_complete' %}
                                    POC 완료
                                {% elif history.new_status.value == 'cancelled' %}
                                    취소됨
                                {% endif %}
                            </td>
                            <td>{{ history.created_by }}</td>
                            <td>{{ history.reason or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 모달 다이얼로그들 -->
{% include 'modals/cancel_modal.html' %}
{% include 'modals/extend_modal.html' %}
{% include 'modals/report_modal.html' %}

{% endblock %}

{% block scripts %}
<script>
async function sendEmail(emailType) {
    try {
        if (emailType === 'submission-complete' || emailType === 'application-complete') {
            window.location.href = `/project/{{ project.id }}/mail/${emailType}`;
            return;
        }
        
        const response = await fetch(`/project/{{ project.id }}/send-email/${emailType}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('이메일이 성공적으로 발송되었습니다.');
            location.reload(); // 페이지 새로고침
        } else {
            alert('이메일 발송 실패: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('이메일 발송 중 오류가 발생했습니다.');
    }
}

async function updateStatus(status) {
    try {
        const response = await fetch(`/project/{{ project.id }}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: status
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('상태가 성공적으로 변경되었습니다.');
            location.reload(); // 페이지 새로고침
        } else {
            alert('상태 변경 실패: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('상태 변경 중 오류가 발생했습니다.');
    }
}

async function startAnalysis() {
    try {
        const response = await fetch(`/project/{{ project.id }}/start-analysis`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('분석이 시작되었습니다.');
            location.reload(); // 페이지 새로고침
        } else {
            alert('분석 시작 실패: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('분석 시작 중 오류가 발생했습니다.');
    }
}

function showCancelModal() {
    // 취소 모달 표시 로직
    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
}
</script>
{% endblock %} 